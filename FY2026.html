<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2026 Free Yourself</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 20px;
        }

        .header h1 {
            font-size: 2em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }

        .status-bar {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 15px;
        }

        .status-message {
            flex: 1;
        }

        .status-message.loading {
            color: #667eea;
            font-weight: 600;
        }

        .status-message.success {
            color: #155724;
            background: #d4edda;
            padding: 10px 15px;
            border-radius: 8px;
        }

        .status-message.error {
            color: #721c24;
            background: #f8d7da;
            padding: 10px 15px;
            border-radius: 8px;
        }

        .config-section {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);
            display: none;
        }

        .config-section.show {
            display: block;
            animation: slideDown 0.3s ease-out;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .config-section h3 {
            color: #667eea;
            margin-bottom: 15px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 600;
        }

        .form-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .form-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-right: 10px;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .calendar-container {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);
            margin-bottom: 20px;
        }

        .calendar {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 8px;
            margin-bottom: 20px;
        }

        .calendar-header {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 8px;
            margin-bottom: 15px;
            text-align: center;
        }

        .weekday {
            font-weight: 600;
            color: #667eea;
            padding: 10px;
            font-size: 14px;
        }

        .day {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            min-height: 80px;
            padding: 8px;
            position: relative;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .day:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            border-color: #667eea;
        }

        .day.holiday {
            background: #ffebee;
            border: 2px solid #ffcdd2;
        }

        .day.workday-adjust {
            background: #fff9c4;
            border: 2px solid #fff59d;
        }

        .day.weekend {
            background: #f5f5f5;
        }

        .day.today {
            border: 3px solid #667eea;
            font-weight: 700;
        }

        .day.checked-in {
            background: #e8f5e9;
            border: 2px solid #81c784;
        }

        .day-number {
            font-size: 16px;
            font-weight: 600;
            color: #333;
            margin-bottom: 4px;
        }

        .day.checked-in .day-number {
            color: #2e7d32;
        }

        .day.checked-in .mood-score {
            color: #333;
        }

        .holiday-label {
            position: absolute;
            top: 2px;
            right: 2px;
            font-size: 0.6em;
            color: rgba(255, 255, 255, 0.9);
            font-weight: 600;
            z-index: 1;
            background: #ff4d4f;
            padding: 2px 4px;
            border-radius: 3px;
        }

        .workday-label {
            position: absolute;
            top: 2px;
            right: 2px;
            font-size: 0.6em;
            color: #f57c00;
            font-weight: 700;
            z-index: 1;
            background: white;
            padding: 2px 4px;
            border-radius: 3px;
            border: 1px solid #f57c00;
        }

        .mood-score {
            font-size: 14px;
            font-weight: 700;
            color: #667eea;
        }

        .stats-section {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);
            display: none;
        }

        .stats-section.show {
            display: block;
            animation: slideDown 0.3s ease-out;
        }

        .stats-section h3 {
            color: #667eea;
            margin-bottom: 15px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: white;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            border: 1px solid #e0e0e0;
        }

        .stat-card h4 {
            font-size: 14px;
            color: #666;
            margin-bottom: 8px;
        }

        .stat-card .value {
            font-size: 24px;
            font-weight: 700;
            color: #667eea;
        }

        .legend {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin-top: 15px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 4px;
            border: 1px solid #ddd;
        }

        .legend-color.holiday {
            background: #ffebee;
            border: 2px solid #ffcdd2;
        }

        .legend-color.workday-adjust {
            background: #ffecb3;
            border: 1px solid #ddd;
        }

        .legend-color.weekend {
            background: #fff5f5;
            border: 1px solid #ddd;
        }

        .legend-color.normal {
            background: white;
            border: 1px solid #ddd;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            align-items: center;
            justify-content: center;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 15px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-header h2 {
            color: #667eea;
            margin: 0;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 28px;
            cursor: pointer;
            color: #999;
        }

        .close-btn:hover {
            color: #333;
        }

        .mood-display {
            font-size: 1.5em;
            font-weight: 700;
        }

        .mood-slider-container {
            margin: 20px 0;
        }

        .mood-slider {
            width: 100%;
            height: 8px;
            border-radius: 4px;
            background: linear-gradient(90deg, #ff6b6b 0%, #ffd93d 50%, #4ecdc4 100%);
            outline: none;
            -webkit-appearance: none;
        }

        .mood-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: white;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
            border: 3px solid #667eea;
        }

        .mood-slider::-moz-range-thumb {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: white;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
            border: 3px solid #667eea;
        }

        .mood-labels {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
            font-size: 12px;
            color: #666;
        }

        .modal-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .modal-actions .btn {
            flex: 1;
        }

        @media (max-width: 768px) {
            .day {
                min-height: 60px;
                padding: 4px;
            }

            .day-number {
                font-size: 12px;
            }

            .mood-score {
                font-size: 11px;
            }

            .holiday-label,
            .workday-label {
                font-size: 0.5em;
                padding: 1px 2px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ“… 2026å¹´æ‰“å¡æ—¥å†</h1>
            <p>è®°å½•æ¯ä¸€å¤©çš„å¿ƒæƒ…ä¸æˆé•¿</p>
        </div>

        <div class="status-bar">
            <div id="statusMessage" class="status-message">
                ç­‰å¾…è¿æ¥ Supabase...
            </div>
            <button class="btn btn-secondary" onclick="showConfig()">âš™ï¸ é…ç½®</button>
        </div>

        <div id="configSection" class="config-section">
            <h3>Supabase é…ç½®</h3>
            <div class="form-group">
                <label for="supabaseUrl">é¡¹ç›® URL</label>
                <input type="text" id="supabaseUrl" placeholder="https://xxx.supabase.co">
            </div>
            <div class="form-group">
                <label for="supabaseKey">API å¯†é’¥</label>
                <input type="password" id="supabaseKey" placeholder="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...">
            </div>
            <div>
                <button class="btn btn-primary" onclick="connectToSupabase()">è¿æ¥</button>
                <button class="btn btn-secondary" onclick="hideConfig()">å–æ¶ˆ</button>
            </div>
        </div>

        <div class="calendar-container">
            <div id="calendar"></div>

            <div class="legend">
                <div class="legend-item">
                    <div class="legend-color holiday"></div>
                    <span>èŠ‚å‡æ—¥</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color workday-adjust"></div>
                    <span>è°ƒä¼‘å·¥ä½œæ—¥</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color weekend"></div>
                    <span>å‘¨æœ«</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color normal"></div>
                    <span>æ™®é€šå·¥ä½œæ—¥</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #e8f5e9; border: 2px solid #81c784;"></div>
                    <span>å·²æ‰“å¡</span>
                </div>
            </div>
        </div>

        <div id="statsSection" class="stats-section">
            <h3>ğŸ“Š ç»Ÿè®¡ä¿¡æ¯</h3>
            <div class="stats-grid">
                <div class="stat-card">
                    <h4>æ‰“å¡æ¬¡æ•°</h4>
                    <div class="value" id="totalCheckins">0</div>
                </div>
                <div class="stat-card">
                    <h4>å¹³å‡å¿ƒæƒ…åˆ†</h4>
                    <div class="value" id="avgMood">0</div>
                </div>
                <div class="stat-card">
                    <h4>æœ¬æœˆæ‰“å¡</h4>
                    <div class="value" id="monthCheckins">0</div>
                </div>
            </div>
        </div>
    </div>

    <div id="checkinModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalDate">æ‰“å¡</h2>
                <button class="close-btn" onclick="closeModal()">&times;</button>
            </div>
            <div class="mood-display" id="moodDisplay">å¿ƒæƒ…ï¼šæ™®é€š ğŸ˜</div>
            <div class="mood-slider-container">
                <input type="range" class="mood-slider" id="moodSlider" min="1" max="10" value="5">
                <div class="mood-labels">
                    <span>ğŸ˜¢ ç³Ÿç³•</span>
                    <span>ğŸ˜ æ™®é€š</span>
                    <span>ğŸ˜Š å¼€å¿ƒ</span>
                </div>
            </div>
            <div class="modal-actions">
                <button class="btn btn-primary" onclick="saveCheckin()">ä¿å­˜</button>
                <button class="btn btn-secondary" onclick="deleteCheckin()">åˆ é™¤</button>
            </div>
        </div>
    </div>

    <script>
        // 2026å¹´æ³•å®šèŠ‚å‡æ—¥é…ç½®ï¼ˆæ ¹æ®å›½åŠ¡é™¢åŠå…¬å…å›½åŠå‘æ˜ç”µã€”2025ã€•7å·é€šçŸ¥ï¼‰
        // è°ƒä¼‘å·¥ä½œæ—¥ï¼š2æœˆ14æ—¥ã€2æœˆ28æ—¥ï¼ˆæ˜¥èŠ‚ï¼‰ï¼›5æœˆ9æ—¥ï¼ˆåŠ³åŠ¨èŠ‚ï¼‰
        const holidays2026 = {
            'æ˜¥èŠ‚': {
                start: { month: 1, day: 15 },
                end: { month: 1, day: 23 },
                workDaysBefore: [{ month: 1, day: 14 }],
                workDaysAfter: [{ month: 1, day: 28 }]
            },
            'æ¸…æ˜èŠ‚': {
                start: { month: 3, day: 4 },
                end: { month: 3, day: 6 },
                workDaysBefore: [],
                workDaysAfter: []
            },
            'åŠ³åŠ¨èŠ‚': {
                start: { month: 4, day: 1 },
                end: { month: 4, day: 5 },
                workDaysBefore: [],
                workDaysAfter: [{ month: 4, day: 9 }]
            },
            'ç«¯åˆèŠ‚': {
                start: { month: 5, day: 19 },
                end: { month: 5, day: 21 },
                workDaysBefore: [],
                workDaysAfter: []
            }
        };

        const DEFAULT_SUPABASE_CONFIG = {
            url: '',
            key: '',
            isConnected: false
        };

        const appState = {
            supabase: null,
            checkInData: {},
            selectedDate: null,
            currentDateMood: 5,
            isConnected: false
        };

        function getSupabaseConfig() {
            
                return {
                    url: 'https://bbmdviffgxarxuptfftp.supabase.co',
                    key: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJibWR2aWZmZ3hhcnh1cHRmZnRwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk5MzgyNzEsImV4cCI6MjA4NTUxNDI3MX0.qqceYnTa7ZtD-Sl1JbNFs1l_0JStdTzrrIXiXv62k54'
                };
        

            return DEFAULT_SUPABASE_CONFIG;
        }

        function showStatus(message, type) {
            const statusElement = document.getElementById('statusMessage');
            statusElement.className = 'status-message ' + type;

            if (type === 'loading') {
                statusElement.innerHTML = `<span class="loading">â³ ${message}</span>`;
            } else if (type === 'success') {
                statusElement.innerHTML = `<span class="success">âœ… ${message}</span>`;
            } else if (type === 'error') {
                statusElement.innerHTML = `<span class="error">âŒ ${message}</span>`;
            }
        }

        async function connectToSupabase(url, key) {
            showStatus('æ­£åœ¨è¿æ¥ Supabase...', 'loading');

            try {
                const supabaseUrl = url || document.getElementById('supabaseUrl').value;
                const supabaseKey = key || document.getElementById('supabaseKey').value;

                if (typeof window.supabase === 'undefined' || typeof window.supabase.createClient !== 'function') {
                    throw new Error('Supabase åº“æœªåŠ è½½ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–åˆ·æ–°é¡µé¢');
                }

                appState.supabase = window.supabase.createClient(supabaseUrl, supabaseKey);
                await checkTableExists();

                localStorage.setItem('calendar_2026_v2_supabaseUrl', supabaseUrl);
                localStorage.setItem('calendar_2026_v2_supabaseKey', supabaseKey);

                appState.isConnected = true;

                const configSection = document.getElementById('configSection');
                configSection.classList.remove('show');

                showStatus('âœ… å·²è¿æ¥åˆ° Supabaseï¼æ•°æ®åŒæ­¥å·²å¯ç”¨ã€‚', 'success');

                await loadCheckins();

                const statsSection = document.getElementById('statsSection');
                statsSection.classList.add('show');

            } catch (error) {
                appState.isConnected = false;
                showStatus('è¿æ¥å¤±è´¥ï¼š' + error.message, 'error');
                console.error('Supabaseè¿æ¥é”™è¯¯:', error);

                const configSection = document.getElementById('configSection');
                configSection.classList.add('show');

                document.getElementById('supabaseUrl').value = url || document.getElementById('supabaseUrl').value;
                document.getElementById('supabaseKey').value = key || document.getElementById('supabaseKey').value;
            }
        }

        async function checkTableExists() {
            const { error } = await appState.supabase
                .from('checkins')
                .select('*')
                .limit(1);

            if (error && error.code === '42P01') {
                throw new Error('è¡¨ "checkins" ä¸å­˜åœ¨ï¼Œè¯·å…ˆåœ¨Supabaseä¸­åˆ›å»ºè¡¨ã€‚');
            }
        }

        async function loadCheckins() {
            if (!appState.supabase) return;

            try {
                const { data, error } = await appState.supabase
                    .from('checkins')
                    .select('*')
                    .order('date', { ascending: true });

                if (error) throw error;

                appState.checkInData = {};
                data.forEach(record => {
                    appState.checkInData[record.date] = {
                        moodScore: record.mood_score,
                        id: record.id
                    };
                });

                renderCalendar();
                updateStats();

            } catch (error) {
                console.error('åŠ è½½æ‰“å¡æ•°æ®å¤±è´¥:', error);
            }
        }

        function getHolidayName(month, day) {
            for (const [name, holiday] of Object.entries(holidays2026)) {
                const start = new Date(2026, holiday.start.month, holiday.start.day);
                const end = new Date(2026, holiday.end.month, holiday.end.day);
                const current = new Date(2026, month, day);
                if (current >= start && current <= end) {
                    return name;
                }
            }
            return null;
        }

        function isWorkdayAdjustment(month, day) {
            for (const holiday of Object.values(holidays2026)) {
                const beforeDays = holiday.workDaysBefore || [];
                const afterDays = holiday.workDaysAfter || [];

                for (const d of [...beforeDays, ...afterDays]) {
                    if (d.month === month && d.day === day) {
                        return true;
                    }
                }
            }
            return false;
        }

        function isHoliday(month, day) {
            return getHolidayName(month, day) !== null;
        }

        function isWorkday(month, day) {
            if (isHoliday(month, day)) {
                return false;
            }

            return true;
        }

        function renderCalendar() {
            const calendarContainer = document.getElementById('calendar');
            calendarContainer.innerHTML = '';

            const months = ['ä¸€æœˆ', 'äºŒæœˆ', 'ä¸‰æœˆ', 'å››æœˆ', 'äº”æœˆ', 'å…­æœˆ'];
            const weekDays = ['å‘¨æ—¥', 'å‘¨ä¸€', 'å‘¨äºŒ', 'å‘¨ä¸‰', 'å‘¨å››', 'å‘¨äº”', 'å‘¨å…­'];

            months.forEach((monthName, monthIndex) => {
                const monthDiv = document.createElement('div');
                monthDiv.className = 'month';

                const monthTitle = document.createElement('h3');
                monthTitle.style.color = '#667eea';
                monthTitle.style.marginBottom = '15px';
                monthTitle.textContent = monthName;
                monthDiv.appendChild(monthTitle);

                const headerDiv = document.createElement('div');
                headerDiv.className = 'calendar-header';
                weekDays.forEach(day => {
                    const dayHeader = document.createElement('div');
                    dayHeader.className = 'weekday';
                    dayHeader.textContent = day;
                    headerDiv.appendChild(dayHeader);
                });
                monthDiv.appendChild(headerDiv);

                const calendarDiv = document.createElement('div');
                calendarDiv.className = 'calendar';

                const daysInMonth = new Date(2026, monthIndex + 1, 0).getDate();
                const firstDayOfMonth = new Date(2026, monthIndex, 1).getDay();

                for (let i = 0; i < firstDayOfMonth; i++) {
                    const emptyDay = document.createElement('div');
                    emptyDay.className = 'day';
                    emptyDay.style.background = '#f5f5f5';
                    emptyDay.style.border = 'none';
                    calendarDiv.appendChild(emptyDay);
                }

                for (let day = 1; day <= daysInMonth; day++) {
                    const dateKey = `2026-${String(monthIndex + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                    const dayOfWeek = new Date(2026, monthIndex, day).getDay();
                    const today = new Date();
                    const isToday = today.getFullYear() === 2026 &&
                                   today.getMonth() === monthIndex &&
                                   today.getDate() === day;

                    const holidayName = getHolidayName(monthIndex, day);
                    const workdayAdjust = isWorkdayAdjustment(monthIndex, day);

                    const dayElement = document.createElement('div');
                    dayElement.className = 'day';
                    if (holidayName) {
                        dayElement.classList.add('holiday');
                    }
                    if (workdayAdjust) {
                        dayElement.classList.add('workday-adjust');
                    }
                    if (dayOfWeek === 0 || dayOfWeek === 6) {
                        dayElement.classList.add('weekend');
                    }
                    if (isToday) {
                        dayElement.classList.add('today');
                    }

                    let dayContent = `<span class="day-number">${day}</span>`;

                    if (holidayName) {
                        dayContent += `<span class="holiday-label">${holidayName}</span>`;
                    } else if (workdayAdjust) {
                        dayContent += `<span class="workday-label">ç­</span>`;
                    }

                    if (appState.checkInData && appState.checkInData[dateKey]) {
                        dayElement.classList.add('checked-in');
                        const record = appState.checkInData[dateKey];
                        if (record.moodScore !== undefined && record.moodScore > 0) {
                            dayContent += `<span class="mood-score">${record.moodScore}</span>`;
                        }
                    }

                    dayElement.innerHTML = dayContent;
                    dayElement.onclick = () => openModal(dateKey);
                    calendarDiv.appendChild(dayElement);
                }

                monthDiv.appendChild(calendarDiv);
                calendarContainer.appendChild(monthDiv);

                const separator = document.createElement('hr');
                separator.style.margin = '30px 0';
                separator.style.border = 'none';
                separator.style.borderTop = '1px solid #e0e0e0';
                calendarContainer.appendChild(separator);
            });
        }

        function updateStats() {
            const checkins = Object.values(appState.checkInData);
            const totalCheckins = checkins.length;
            const avgMood = totalCheckins > 0
                ? (checkins.reduce((sum, r) => sum + (r.moodScore || 0), 0) / totalCheckins).toFixed(1)
                : 0;

            const today = new Date();
            const currentMonth = String(today.getMonth() + 1).padStart(2, '0');
            const monthCheckins = checkins.filter(r => r.id.includes(currentMonth)).length;

            document.getElementById('totalCheckins').textContent = totalCheckins;
            document.getElementById('avgMood').textContent = avgMood;
            document.getElementById('monthCheckins').textContent = monthCheckins;
        }

        function openModal(dateKey) {
            appState.selectedDate = dateKey;

            const record = appState.checkInData[dateKey];
            const moodScore = record ? record.moodScore : 5;

            document.getElementById('moodSlider').value = moodScore;
            updateMoodDisplay(moodScore);

            const dateParts = dateKey.split('-');
            document.getElementById('modalDate').textContent = `${dateParts[0]}å¹´${parseInt(dateParts[1])}æœˆ${parseInt(dateParts[2])}æ—¥æ‰“å¡`;

            document.getElementById('checkinModal').classList.add('show');
        }

        function closeModal() {
            document.getElementById('checkinModal').classList.remove('show');
            appState.selectedDate = null;
        }

        function updateMoodDisplay(value) {
            const moodDisplay = document.getElementById('moodDisplay');
            let moodText = '';
            let moodEmoji = '';

            if (value <= 2) {
                moodText = 'ç³Ÿç³•';
                moodEmoji = 'ğŸ˜¢';
            } else if (value <= 4) {
                moodText = 'ä¸å¤ªå¥½';
                moodEmoji = 'ğŸ˜Ÿ';
            } else if (value <= 6) {
                moodText = 'æ™®é€š';
                moodEmoji = 'ğŸ˜';
            } else if (value <= 8) {
                moodText = 'ä¸é”™';
                moodEmoji = 'ğŸ™‚';
            } else {
                moodText = 'å¼€å¿ƒ';
                moodEmoji = 'ğŸ˜Š';
            }

            moodDisplay.textContent = `å¿ƒæƒ…ï¼š${moodText} ${moodEmoji} (${value}/10)`;
        }

        async function saveCheckin() {
            if (!appState.selectedDate || !appState.supabase) {
                closeModal();
                return;
            }

            const moodScore = parseInt(document.getElementById('moodSlider').value);
            const existingRecord = appState.checkInData[appState.selectedDate];

            try {
                if (existingRecord) {
                    const { error } = await appState.supabase
                        .from('checkins')
                        .update({ mood_score: moodScore })
                        .eq('id', existingRecord.id);

                    if (error) throw error;
                } else {
                    const { error } = await appState.supabase
                        .from('checkins')
                        .insert([
                            { date: appState.selectedDate, mood_score: moodScore }
                        ]);

                    if (error) throw error;
                }

                appState.checkInData[appState.selectedDate] = {
                    moodScore: moodScore,
                    id: existingRecord ? existingRecord.id : appState.selectedDate
                };

                renderCalendar();
                updateStats();
                closeModal();
                showStatus('âœ… æ‰“å¡æˆåŠŸï¼', 'success');

            } catch (error) {
                console.error('ä¿å­˜æ‰“å¡å¤±è´¥:', error);
                showStatus('âŒ ä¿å­˜å¤±è´¥ï¼š' + error.message, 'error');
            }
        }

        async function deleteCheckin() {
            if (!appState.selectedDate || !appState.supabase) {
                closeModal();
                return;
            }

            const existingRecord = appState.checkInData[appState.selectedDate];

            if (!existingRecord) {
                closeModal();
                return;
            }

            try {
                const { error } = await appState.supabase
                    .from('checkins')
                    .delete()
                    .eq('id', existingRecord.id);

                if (error) throw error;

                delete appState.checkInData[appState.selectedDate];

                renderCalendar();
                updateStats();
                closeModal();
                showStatus('âœ… å·²åˆ é™¤æ‰“å¡è®°å½•', 'success');

            } catch (error) {
                console.error('åˆ é™¤æ‰“å¡å¤±è´¥:', error);
                showStatus('âŒ åˆ é™¤å¤±è´¥ï¼š' + error.message, 'error');
            }
        }

        function showConfig() {
            const configSection = document.getElementById('configSection');
            configSection.classList.add('show');

            const config = getSupabaseConfig();
            if (config.url) {
                document.getElementById('supabaseUrl').value = config.url;
            }
            if (config.key) {
                document.getElementById('supabaseKey').value = config.key;
            }
        }

        function hideConfig() {
            const configSection = document.getElementById('configSection');
            configSection.classList.remove('show');
        }

        document.getElementById('moodSlider').addEventListener('input', function() {
            updateMoodDisplay(this.value);
        });

        document.getElementById('checkinModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeModal();
            }
        });

        window.addEventListener('load', async function() {
            const config = getSupabaseConfig();
            if (config.url && config.key) {
                showStatus('è‡ªåŠ¨è¿æ¥ Supabase ä¸­...', 'loading');
                await connectToSupabase(config.url, config.key);
            } else {
                showStatus('è¯·é…ç½® Supabase è¿æ¥ä¿¡æ¯', 'loading');
                showConfig();
            }
        });
    </script>
</body>
</html>
