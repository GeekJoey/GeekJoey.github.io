<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2026å¹´æ‰“å¡æ—¥å†</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 20px;
        }

        .header h1 {
            font-size: 2em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }

        .status-bar {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 15px;
        }

        .status-message {
            flex: 1;
        }

        .status-message.loading {
            color: #667eea;
            font-weight: 600;
        }

        .status-message.success {
            color: #155724;
            background: #d4edda;
            padding: 10px 15px;
            border-radius: 8px;
        }

        .status-message.error {
            color: #721c24;
            background: #f8d7da;
            padding: 10px 15px;
            border-radius: 8px;
        }

        .config-section {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);
            display: none;
        }

        .config-section.show {
            display: block;
            animation: slideDown 0.3s ease-out;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .config-section h3 {
            color: #667eea;
            margin-bottom: 15px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #555;
        }

        .form-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .form-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #f0f0f0;
            color: #555;
        }

        .btn-secondary:hover {
            background: #e0e0e0;
        }

        .btn-settings {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .btn-settings:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .stats-section {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);
            display: none;
        }

        .stats-section.show {
            display: block;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
        }

        .stat-card {
            text-align: center;
            padding: 20px;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            border-radius: 12px;
        }

        .stat-value {
            font-size: 2.5em;
            font-weight: 700;
            color: #667eea;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.9em;
            color: #777;
        }

        .countdown-box {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            text-align: center;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);
        }

        .countdown-title {
            font-size: 1.1em;
            color: #555;
            margin-bottom: 10px;
        }

        .countdown-days {
            font-size: 3em;
            font-weight: 700;
            color: #667eea;
            margin-bottom: 5px;
        }

        .countdown-label {
            font-size: 0.9em;
            color: #777;
        }

        .current-date {
            color: #777;
            font-size: 0.9em;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(1, 1fr);
            gap: 20px;
        }

        .month-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);
        }

        .month-title {
            text-align: center;
            font-size: 1.5em;
            font-weight: 700;
            color: #667eea;
            margin-bottom: 15px;
        }

        .days-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 8px;
        }

        .day {
            aspect-ratio: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            font-size: 0.9em;
            padding: 8px 4px;
        }

        .day:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .day.other-month {
            color: #ccc;
            background: #f5f5f5;
        }

        .day.weekend {
            background: #fff5f5;
            border: 1px solid #ddd;
        }

        .day.holiday {
            background: linear-gradient(135deg, #ffd93d 0%, #ff9a3c 100%);
            color: white;
            font-weight: 600;
        }

        .day.workday-adjust {
            background: #ffecb3;
            border: 1px solid #ddd;
        }

        .day.today {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-weight: 700;
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .day.checked-in {
            background: linear-gradient(135deg, #a8ff78 0%, #78ffd6 100%);
            font-weight: 600;
        }

        .day-number {
            font-size: 1.1em;
            margin-bottom: 4px;
        }

        .mood-score {
            font-size: 0.75em;
            color: #667eea;
            font-weight: 700;
        }

        .day.checked-in .mood-score {
            color: #333;
        }

        .mood-indicator {
            position: absolute;
            bottom: 4px;
            right: 4px;
            font-size: 0.9em;
        }

        .legend {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin: 15px 0;
            padding: 15px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 12px;
            font-size: 0.9em;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .legend-color {
            width: 18px;
            height: 18px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7em;
            color: #333;
            font-weight: 600;
        }

        .legend-color.today {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .legend-color.checked-in {
            background: linear-gradient(135deg, #a8ff78 0%, #78ffd6 100%);
        }

        .legend-color.holiday {
            background: linear-gradient(135deg, #ffd93d 0%, #ff9a3c 100%);
            color: white;
        }

        .legend-color.workday-adjust {
            background: #ffecb3;
            border: 1px solid #ddd;
        }

        .legend-color.weekend {
            background: #fff5f5;
            border: 1px solid #ddd;
        }

        .legend-color.normal {
            background: white;
            border: 1px solid #ddd;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            align-items: center;
            justify-content: center;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 15px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-header h2 {
            color: #667eea;
            margin: 0;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 28px;
            cursor: pointer;
            color: #999;
        }

        .close-btn:hover {
            color: #333;
        }

        .mood-display {
            font-size: 1.5em;
            font-weight: 700;
        }

        .mood-slider-container {
            margin: 20px 0;
        }

        .mood-slider {
            width: 100%;
            height: 8px;
            border-radius: 4px;
            background: linear-gradient(90deg, #ff6b6b 0%, #ffd93d 50%, #4ecdc4 100%);
            outline: none;
            -webkit-appearance: none;
        }

        .mood-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: white;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
            border: 3px solid #667eea;
        }

        .mood-slider::-moz-range-thumb {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: white;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
            border: 3px solid #667eea;
        }

        .mood-value {
            text-align: center;
            font-size: 1.5em;
            font-weight: 700;
            color: #667eea;
            margin-top: 10px;
        }

        .mood-emoji {
            font-size: 2em;
            text-align: center;
            margin-top: 10px;
        }

        textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
            resize: vertical;
            min-height: 80px;
        }

        textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .modal-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .checkin-detail {
            margin-top: 20px;
            padding: 15px;
            background: #f5f5f5;
            border-radius: 8px;
        }

        .checkin-detail p {
            margin: 8px 0;
        }

        @media (max-width: 768px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }

            .days-grid {
                gap: 4px;
            }

            .day {
                font-size: 0.8em;
                padding: 6px 2px;
            }

            .mood-score {
                font-size: 0.65em;
            }

            .status-bar {
                flex-direction: column;
                align-items: flex-start;
            }

            .btn-settings {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ“… 2026å¹´æ‰“å¡æ—¥å†</h1>
            <p style="color: rgba(255,255,255,0.8);">è®°å½•æ¯ä¸€å¤©çš„å¿ƒæƒ…ä¸æˆé•¿</p>
        </div>

        <!-- çŠ¶æ€æ  -->
        <div class="status-bar" id="statusBar">
            <div class="status-message" id="statusMessage">
                <span class="loading">â³ æ­£åœ¨è¿æ¥ Supabase...</span>
            </div>
            <button class="btn btn-settings" id="settingsBtn">âš™ï¸ è®¾ç½® Supabase</button>
        </div>

        <!-- Supabase é…ç½®é¢æ¿ï¼ˆé»˜è®¤éšè—ï¼‰ -->
        <div class="config-section" id="configSection">
            <h3>ğŸ”— Supabase äº‘åŒæ­¥é…ç½®</h3>
            <div class="form-group">
                <label for="supabaseUrl">Supabase URL</label>
                <input type="text" id="supabaseUrl" placeholder="https://xxxxx.supabase.co">
            </div>
            <div class="form-group">
                <label for="supabaseKey">Supabase Anon Key</label>
                <input type="password" id="supabaseKey" placeholder="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...">
            </div>
            <div>
                <button class="btn btn-primary" id="saveConfigBtn">ä¿å­˜å¹¶é‡æ–°è¿æ¥</button>
                <button class="btn btn-secondary" id="cancelConfigBtn">å–æ¶ˆ</button>
            </div>
        </div>

        <!-- ç»Ÿè®¡ä¿¡æ¯ -->
        <div class="stats-section" id="statsSection">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="totalCheckins">0</div>
                    <div class="stat-label">æ‰“å¡å¤©æ•°</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="avgMood">0</div>
                    <div class="stat-label">å¹³å‡å¿ƒæƒ…</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="streak">0</div>
                    <div class="stat-label">è¿ç»­æ‰“å¡å¤©æ•°</div>
                </div>
            </div>
        </div>

        <!-- å€’è®¡æ—¶ -->
        <div class="countdown-box">
            <div class="countdown-title">è·ç¦» 6æœˆ12æ—¥ è¿˜æœ‰</div>
            <div class="countdown-days" id="countdown">-</div>
            <div class="countdown-label">ä¸ªå·¥ä½œæ—¥ï¼ˆéå‘¨æœ«+èŠ‚å‡æ—¥ï¼‰</div>
            <div style="margin-top: 10px;">
                <span class="current-date">ä»Šå¤©ï¼š<span id="currentDate"></span></span>
            </div>
        </div>

        <!-- å›¾ä¾‹è¯´æ˜ -->
        <div class="legend">
            <div class="legend-item">
                <div class="legend-color today">ä»Š</div>
                <span>ä»Šå¤©</span>
            </div>
            <div class="legend-item">
                <div class="legend-color checked-in">âœ“</div>
                <span>å·²æ‰“å¡</span>
            </div>
            <div class="legend-item">
                <div class="legend-color holiday">ğŸ‰</div>
                <span>èŠ‚å‡æ—¥</span>
            </div>
            <div class="legend-item">
                <div class="legend-color workday-adjust">ğŸ“…</div>
                <span>è°ƒä¼‘å·¥ä½œæ—¥</span>
            </div>
            <div class="legend-item">
                <div class="legend-color weekend"></div>
                <span>å‘¨æœ«</span>
            </div>
            <div class="legend-item">
                <div class="legend-color normal"></div>
                <span>æ™®é€šå·¥ä½œæ—¥</span>
            </div>
        </div>

        <!-- æ—¥å† -->
        <div class="calendar-grid" id="calendarGrid"></div>
    </div>

    <!-- æ‰“å¡æ¨¡æ€æ¡† -->
    <div class="modal" id="checkinModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">æ‰“å¡</h2>
                <button class="close-btn" id="closeModalBtn">&times;</button>
            </div>

            <!-- æ‰“å¡è¡¨å• -->
            <div class="checkin-form" id="checkinForm">
                <div class="mood-slider-container">
                    <label style="display: block; margin-bottom: 10px; font-weight: 600;">å¿ƒæƒ…å€¼ (1-100)</label>
                    <input type="range" class="mood-slider" id="moodSlider" min="1" max="100" value="50">
                    <div class="mood-value" id="moodValue">50</div>
                    <div class="mood-emoji" id="moodEmoji">ğŸ˜</div>
                </div>

                <div class="form-group">
                    <label for="note">è®°å½•å†…å®¹</label>
                    <textarea id="note" placeholder="ä»Šå¤©å‘ç”Ÿäº†ä»€ä¹ˆï¼Ÿè®°å½•ä¸‹ä½ çš„æƒ³æ³•..."></textarea>
                </div>

                <div class="modal-actions">
                    <button class="btn btn-secondary" id="cancelBtn">å–æ¶ˆ</button>
                    <button class="btn btn-primary" id="saveCheckinBtn">ä¿å­˜æ‰“å¡</button>
                </div>
            </div>

            <!-- æŸ¥çœ‹è¯¦æƒ… -->
            <div class="checkin-detail" id="checkinDetail" style="display: none;">
                <p><strong>å¿ƒæƒ…å€¼ï¼š</strong><span class="mood-display" id="detailMood"></span></p>
                <p><strong>è®°å½•ï¼š</strong><span id="detailText"></span></p>
                <p><strong>æ—¶é—´ï¼š</strong><span id="detailTime"></span></p>
                <div class="modal-actions">
                    <button class="btn btn-secondary" id="closeDetailBtn">å…³é—­</button>
                    <button class="btn btn-primary" id="deleteCheckinBtn">åˆ é™¤æ‰“å¡</button>
                </div>
            </div>
        </div>
    </div>

    <script>
    // ä½¿ç”¨ IIFE ç«‹å³æ‰§è¡Œå‡½æ•°ï¼Œå°†æ‰€æœ‰ä»£ç å°è£…åœ¨ç‹¬ç«‹ä½œç”¨åŸŸä¸­
    (function() {
        // ============================================================
        // ğŸ”’ é…ç½®åŒºåŸŸï¼šåœ¨è¿™é‡Œä¿®æ”¹ä½ çš„ Supabase è¿æ¥ä¿¡æ¯
        // ============================================================
        const DEFAULT_SUPABASE_CONFIG = {
            url: 'https://bbmdviffgxarxuptfftp.supabase.co',  // ğŸ‘ˆ åœ¨è¿™é‡Œå¡«å…¥ä½ çš„ Supabase URL
            key: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJibWR2aWZmZ3hhcnh1cHRmZnRwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk5MzgyNzEsImV4cCI6MjA4NTUxNDI3MX0.qqceYnTa7ZtD-Sl1JbNFs1l_0JStdTzrrIXiXv62k54'  // ğŸ‘ˆ åœ¨è¿™é‡Œå¡«å…¥ä½ çš„ Supabase Anon Key
        };
        // ============================================================

        // 2026å¹´æ³•å®šèŠ‚å‡æ—¥é…ç½®
        const holidays2026 = {
            'æ˜¥èŠ‚': {
                start: { month: 1, day: 15 },
                end: { month: 1, day: 23 },
                workDaysBefore: [{ month: 1, day: 14 }],
                workDaysAfter: [{ month: 1, day: 28 }]
            },
            'æ¸…æ˜èŠ‚': {
                start: { month: 3, day: 4 },
                end: { month: 3, day: 6 },
                workDaysBefore: [],
                workDaysAfter: []
            },
            'åŠ³åŠ¨èŠ‚': {
                start: { month: 4, day: 1 },
                end: { month: 4, day: 5 },
                workDaysBefore: [],
                workDaysAfter: [{ month: 4, day: 9 }]
            },
            'ç«¯åˆèŠ‚': {
                start: { month: 5, day: 19 },
                end: { month: 5, day: 21 },
                workDaysBefore: [],
                workDaysAfter: []
            }
        };

        // åº”ç”¨çŠ¶æ€
        const appState = {
            supabase: null,
            checkins: [],
            selectedDate: null,
            isConnected: false
        };

        // è·å–æœ‰æ•ˆçš„ Supabase é…ç½®ï¼ˆä¼˜å…ˆä½¿ç”¨ localStorageï¼Œå¦åˆ™ä½¿ç”¨é»˜è®¤å€¼ï¼‰
        function getSupabaseConfig() {
            const localStorageUrl = localStorage.getItem('calendar_2026_v2_supabaseUrl');
            const localStorageKey = localStorage.getItem('calendar_2026_v2_supabaseKey');

            if (localStorageUrl && localStorageKey) {
                return {
                    url: localStorageUrl,
                    key: localStorageKey
                };
            }

            return DEFAULT_SUPABASE_CONFIG;
        }

        // æ˜¾ç¤ºçŠ¶æ€æ¶ˆæ¯
        function showStatus(message, type) {
            const statusElement = document.getElementById('statusMessage');
            statusElement.className = 'status-message ' + type;

            if (type === 'loading') {
                statusElement.innerHTML = `<span class="loading">â³ ${message}</span>`;
            } else if (type === 'success') {
                statusElement.innerHTML = `<span class="success">âœ… ${message}</span>`;
            } else if (type === 'error') {
                statusElement.innerHTML = `<span class="error">âŒ ${message}</span>`;
            }
        }

        // è¿æ¥Supabase
        async function connectSupabase(url, key) {
            showStatus('æ­£åœ¨è¿æ¥ Supabase...', 'loading');

            try {
                // æ£€æŸ¥ Supabase åº“æ˜¯å¦åŠ è½½
                if (typeof window.supabase === 'undefined' || typeof window.supabase.createClient !== 'function') {
                    throw new Error('Supabase åº“æœªåŠ è½½ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–åˆ·æ–°é¡µé¢');
                }

                appState.supabase = window.supabase.createClient(url, key);
                await checkTableExists();

                // ä¿å­˜é…ç½®åˆ° localStorage
                localStorage.setItem('calendar_2026_v2_supabaseUrl', url);
                localStorage.setItem('calendar_2026_v2_supabaseKey', key);

                appState.isConnected = true;

                // è¿æ¥æˆåŠŸåï¼Œè‡ªåŠ¨éšè—é…ç½®é¢æ¿
                const configSection = document.getElementById('configSection');
                configSection.classList.remove('show');

                showStatus('âœ… å·²è¿æ¥åˆ° Supabaseï¼æ•°æ®åŒæ­¥å·²å¯ç”¨ã€‚', 'success');

                // åŠ è½½æ‰“å¡æ•°æ®
                await loadCheckins();

                // æ˜¾ç¤ºç»Ÿè®¡ä¿¡æ¯
                const statsSection = document.getElementById('statsSection');
                statsSection.classList.add('show');

            } catch (error) {
                appState.isConnected = false;
                showStatus('è¿æ¥å¤±è´¥ï¼š' + error.message, 'error');
                console.error('Supabaseè¿æ¥é”™è¯¯:', error);

                // è¿æ¥å¤±è´¥æ—¶ï¼Œæ˜¾ç¤ºé…ç½®é¢æ¿
                const configSection = document.getElementById('configSection');
                configSection.classList.add('show');

                // é¢„å¡«å……è¾“å…¥æ¡†
                document.getElementById('supabaseUrl').value = url;
                document.getElementById('supabaseKey').value = key;
            }
        }

        // æ£€æŸ¥è¡¨æ˜¯å¦å­˜åœ¨ï¼Œä¸å­˜åœ¨åˆ™åˆ›å»º
        async function checkTableExists() {
            const { error } = await appState.supabase
                .from('checkins')
                .select('*')
                .limit(1);

            if (error && error.code === '42P01') {
                throw new Error('è¡¨ "checkins" ä¸å­˜åœ¨ï¼Œè¯·å…ˆåœ¨Supabaseä¸­åˆ›å»ºè¡¨ã€‚');
            }
        }

        // åŠ è½½æ‰“å¡æ•°æ®
        async function loadCheckins() {
            if (!appState.supabase) return;

            try {
                const { data, error } = await appState.supabase
                    .from('checkins')
                    .select('*')
                    .order('date', { ascending: true });

                if (error) throw error;

                appState.checkins = data || [];
                renderCalendar();
                updateStats();
            } catch (error) {
                console.error('åŠ è½½æ•°æ®å¤±è´¥:', error);
            }
        }

        // ä¿å­˜æ‰“å¡
        async function saveCheckin() {
            if (!appState.supabase) {
                alert('è¯·å…ˆè¿æ¥Supabase');
                return;
            }

            const mood = parseInt(document.getElementById('moodSlider').value);
            const note = document.getElementById('note').value.trim();
            const dateStr = appState.selectedDate.toISOString().split('T')[0];

            try {
                const { error } = await appState.supabase
                    .from('checkins')
                    .insert({
                        date: dateStr,
                        mood: mood,
                        note: note,
                        created_at: new Date().toISOString()
                    });

                if (error) throw error;

                await loadCheckins();
                closeModal();
                showStatus('âœ… æ‰“å¡æˆåŠŸï¼', 'success');
            } catch (error) {
                console.error('ä¿å­˜å¤±è´¥:', error);
                alert('ä¿å­˜å¤±è´¥ï¼š' + error.message);
            }
        }

        // åˆ é™¤æ‰“å¡
        async function deleteCheckin() {
            if (!appState.supabase || !appState.selectedDate) return;

            const dateStr = appState.selectedDate.toISOString().split('T')[0];

            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡æ‰“å¡è®°å½•å—ï¼Ÿ')) return;

            try {
                const { error } = await appState.supabase
                    .from('checkins')
                    .delete()
                    .eq('date', dateStr);

                if (error) throw error;

                await loadCheckins();
                closeModal();
                showStatus('âœ… å·²åˆ é™¤æ‰“å¡è®°å½•', 'success');
            } catch (error) {
                console.error('åˆ é™¤å¤±è´¥:', error);
                alert('åˆ é™¤å¤±è´¥ï¼š' + error.message);
            }
        }

        // æ‰“å¼€æ‰“å¡æ¨¡æ€æ¡†
        function openCheckinModal(date) {
            if (!appState.isConnected) {
                alert('è¯·å…ˆè¿æ¥ Supabase æ‰èƒ½æ‰“å¡ï¼');
                const configSection = document.getElementById('configSection');
                configSection.classList.add('show');
                return;
            }

            appState.selectedDate = date;
            const dateStr = date.toISOString().split('T')[0];

            // æ£€æŸ¥æ˜¯å¦å·²æœ‰æ‰“å¡
            const existingCheckin = appState.checkins.find(c => c.date === dateStr);

            if (existingCheckin) {
                // æ˜¾ç¤ºè¯¦æƒ…
                document.getElementById('modalTitle').textContent = 'æ‰“å¡è¯¦æƒ…';
                document.getElementById('checkinForm').style.display = 'none';
                document.getElementById('checkinDetail').style.display = 'block';
                document.getElementById('detailMood').textContent = existingCheckin.mood;
                document.getElementById('detailText').textContent = existingCheckin.note || 'æ— ';
                document.getElementById('detailTime').textContent = new Date(existingCheckin.created_at).toLocaleString('zh-CN');
            } else {
                // æ˜¾ç¤ºè¡¨å•
                document.getElementById('modalTitle').textContent = 'æ‰“å¡';
                document.getElementById('checkinForm').style.display = 'block';
                document.getElementById('checkinDetail').style.display = 'none';
                document.getElementById('moodSlider').value = 50;
                document.getElementById('note').value = '';
                updateMoodDisplay();
            }

            document.getElementById('checkinModal').classList.add('show');
        }

        // å…³é—­æ¨¡æ€æ¡†
        function closeModal() {
            document.getElementById('checkinModal').classList.remove('show');
            appState.selectedDate = null;
        }

        // æ›´æ–°å¿ƒæƒ…æ˜¾ç¤º
        function updateMoodDisplay() {
            const value = document.getElementById('moodSlider').value;
            document.getElementById('moodValue').textContent = value;

            let emoji = 'ğŸ˜';
            if (value <= 20) emoji = 'ğŸ˜¢';
            else if (value <= 40) emoji = 'ğŸ˜•';
            else if (value <= 60) emoji = 'ğŸ˜';
            else if (value <= 80) emoji = 'ğŸ˜Š';
            else emoji = 'ğŸ˜„';

            document.getElementById('moodEmoji').textContent = emoji;
        }

        // è·å–å¿ƒæƒ…emoji
        function getMoodEmoji(value) {
            if (value <= 20) return 'ğŸ˜¢';
            if (value <= 40) return 'ğŸ˜•';
            if (value <= 60) return 'ğŸ˜';
            if (value <= 80) return 'ğŸ˜Š';
            return 'ğŸ˜„';
        }

        // åˆ¤æ–­æ˜¯å¦æ˜¯èŠ‚å‡æ—¥
        function isHoliday(month, day) {
            for (const holiday of Object.values(holidays2026)) {
                const start = new Date(2026, holiday.start.month, holiday.start.day);
                const end = new Date(2026, holiday.end.month, holiday.end.day);
                const current = new Date(2026, month, day);
                if (current >= start && current <= end) {
                    return true;
                }
            }
            return false;
        }

        // åˆ¤æ–­æ˜¯å¦æ˜¯è°ƒä¼‘å·¥ä½œæ—¥
        function isWorkdayAdjustment(month, day) {
            for (const holiday of Object.values(holidays2026)) {
                const beforeDays = holiday.workDaysBefore || [];
                const afterDays = holiday.workDaysAfter || [];

                for (const d of [...beforeDays, ...afterDays]) {
                    if (d.month === month && d.day === day) {
                        return true;
                    }
                }
            }
            return false;
        }

        // åˆ¤æ–­æ˜¯å¦æ˜¯å·¥ä½œæ—¥
        function isWorkday(date) {
            const day = date.getDay();
            const month = date.getMonth();
            const dayOfMonth = date.getDate();

            // å‘¨æœ«ä½†è°ƒä¼‘å·¥ä½œæ—¥
            if ((day === 0 || day === 6) && isWorkdayAdjustment(month, dayOfMonth)) {
                return true;
            }

            // å‘¨æœ«ï¼ˆéè°ƒä¼‘ï¼‰
            if (day === 0 || day === 6) {
                return false;
            }

            // å·¥ä½œæ—¥ä½†èŠ‚å‡æ—¥
            if (isHoliday(month, dayOfMonth)) {
                return false;
            }

            return true;
        }

        // è®¡ç®—å·¥ä½œæ—¥å€’è®¡æ—¶
        function calculateWorkdays() {
            const today = new Date();
            const targetDate = new Date(2026, 5, 12); // 6æœˆ12æ—¥

            if (today > targetDate) return 0;

            let workdays = 0;
            let current = new Date(today);
            current.setDate(current.getDate() + 1); // ä»æ˜å¤©å¼€å§‹è®¡ç®—

            while (current < targetDate) {
                if (isWorkday(current)) {
                    workdays++;
                }
                current.setDate(current.getDate() + 1);
            }

            return workdays;
        }

        // æ›´æ–°å€’è®¡æ—¶
        function updateCountdown() {
            const workdays = calculateWorkdays();
            document.getElementById('countdown').textContent = workdays;

            const today = new Date();
            const options = { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' };
            document.getElementById('currentDate').textContent = today.toLocaleDateString('zh-CN', options);
        }

        // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
        function updateStats() {
            const total = appState.checkins.length;
            const avg = total > 0 ? Math.round(appState.checkins.reduce((sum, c) => sum + c.mood, 0) / total) : 0;
            const streak = calculateStreak();

            document.getElementById('totalCheckins').textContent = total;
            document.getElementById('avgMood').textContent = avg;
            document.getElementById('streak').textContent = streak;
        }

        // è®¡ç®—è¿ç»­æ‰“å¡å¤©æ•°
        function calculateStreak() {
            if (appState.checkins.length === 0) return 0;

            const today = new Date();
            const sortedDates = appState.checkins
                .map(c => new Date(c.date))
                .sort((a, b) => b - a);

            let streak = 0;
            let currentDate = new Date(today);

            for (const checkinDate of sortedDates) {
                const diffDays = Math.floor((currentDate - checkinDate) / (1000 * 60 * 60 * 24));

                if (diffDays <= 1) {
                    streak++;
                    currentDate = new Date(checkinDate);
                    currentDate.setDate(currentDate.getDate() - 1);
                } else {
                    break;
                }
            }

            return streak;
        }

        // ç”Ÿæˆå•æœˆæ—¥å†
        function generateMonthCalendar(month) {
            const year = 2026;
            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const monthNames = ['ä¸€æœˆ', 'äºŒæœˆ', 'ä¸‰æœˆ', 'å››æœˆ', 'äº”æœˆ', 'å…­æœˆ', 'ä¸ƒæœˆ', 'å…«æœˆ', 'ä¹æœˆ', 'åæœˆ', 'åä¸€æœˆ', 'åäºŒæœˆ'];

            let html = `
                <div class="month-card">
                    <div class="month-title">${monthNames[month]}</div>
                    <div class="days-grid">
            `;

            // æ˜ŸæœŸæ ‡é¢˜
            const weekDays = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];
            weekDays.forEach(day => {
                html += `<div class="day" style="font-weight: 600; color: #667eea; cursor: default;">${day}</div>`;
            });

            // ç©ºç™½æ—¥æœŸ
            for (let i = 0; i < firstDay; i++) {
                html += `<div class="day other-month"></div>`;
            }

            // æ—¥æœŸ
            const today = new Date();
            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(year, month, day);
                const dateStr = date.toISOString().split('T')[0];
                const dayOfWeek = date.getDay();
                const dayOfMonth = date.getDate();

                let className = 'day';

                // åˆ¤æ–­æ—¥æœŸç±»å‹
                if (today.getFullYear() === year && today.getMonth() === month && today.getDate() === day) {
                    className += ' today';
                } else if (dayOfWeek === 0 || dayOfWeek === 6) {
                    className += ' weekend';
                } else if (isHoliday(month, dayOfMonth)) {
                    className += ' holiday';
                } else if (isWorkdayAdjustment(month, dayOfMonth)) {
                    className += ' workday-adjust';
                }

                // æ£€æŸ¥æ˜¯å¦æœ‰æ‰“å¡
                const checkin = appState.checkins.find(c => c.date === dateStr);
                if (checkin) {
                    className += ' checked-in';
                }

                const moodScore = checkin ? `<span class="mood-score">${checkin.mood}åˆ†</span>` : '';
                const moodIndicator = checkin ? `<span class="mood-indicator">${getMoodEmoji(checkin.mood)}</span>` : '';

                html += `
                    <div class="${className}" data-date="${dateStr}">
                        <span class="day-number">${day}</span>
                        ${moodScore}
                        ${moodIndicator}
                    </div>
                `;
            }

            html += `
                    </div>
                </div>
            `;

            return html;
        }

        // æ¸²æŸ“æ—¥å†
        function renderCalendar() {
            const grid = document.getElementById('calendarGrid');
            let html = '';

            // 2æœˆåˆ°6æœˆï¼ˆç´¢å¼•1åˆ°5ï¼‰
            for (let month = 1; month <= 5; month++) {
                html += generateMonthCalendar(month);
            }

            grid.innerHTML = html;

            // æ·»åŠ ç‚¹å‡»äº‹ä»¶
            document.querySelectorAll('.day[data-date]').forEach(dayElement => {
                dayElement.addEventListener('click', function() {
                    const dateStr = this.getAttribute('data-date');
                    const date = new Date(dateStr);
                    openCheckinModal(date);
                });
            });
        }

        // æ˜¾ç¤ºé…ç½®é¢æ¿
        function showConfigPanel() {
            const configSection = document.getElementById('configSection');
            configSection.classList.toggle('show');

            // é¢„å¡«å……å½“å‰é…ç½®
            const config = getSupabaseConfig();
            document.getElementById('supabaseUrl').value = config.url;
            document.getElementById('supabaseKey').value = config.key;
        }

        // ä¿å­˜é…ç½®å¹¶é‡æ–°è¿æ¥
        async function saveAndReconnect() {
            const url = document.getElementById('supabaseUrl').value.trim();
            const key = document.getElementById('supabaseKey').value.trim();

            if (!url || !key) {
                alert('è¯·è¾“å…¥Supabase URLå’ŒKey');
                return;
            }

            await connectSupabase(url, key);
        }

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            // ç»‘å®šäº‹ä»¶
            document.getElementById('settingsBtn').addEventListener('click', showConfigPanel);
            document.getElementById('saveConfigBtn').addEventListener('click', saveAndReconnect);
            document.getElementById('cancelConfigBtn').addEventListener('click', function() {
                const configSection = document.getElementById('configSection');
                configSection.classList.remove('show');
            });
            document.getElementById('closeModalBtn').addEventListener('click', closeModal);
            document.getElementById('cancelBtn').addEventListener('click', closeModal);
            document.getElementById('saveCheckinBtn').addEventListener('click', saveCheckin);
            document.getElementById('deleteCheckinBtn').addEventListener('click', deleteCheckin);
            document.getElementById('closeDetailBtn').addEventListener('click', closeModal);
            document.getElementById('moodSlider').addEventListener('input', updateMoodDisplay);

            // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
            document.getElementById('checkinModal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeModal();
                }
            });

            // æ¸²æŸ“æ—¥å†
            renderCalendar();

            // æ›´æ–°å€’è®¡æ—¶
            updateCountdown();

            // è‡ªåŠ¨è¿æ¥ Supabase
            const config = getSupabaseConfig();
            if (config.url && config.key && config.url !== 'https://your-project.supabase.co') {
                connectSupabase(config.url, config.key);
            } else {
                showStatus('è¯·ç‚¹å‡»"è®¾ç½® Supabase"é…ç½®è¿æ¥ä¿¡æ¯', 'error');
            }
        });
    })();
    </script>
</body>
</html>